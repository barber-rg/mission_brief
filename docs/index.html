<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Brief Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .no-export {
            /* This class is used to hide elements in the final PDF */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <div class="text-center mb-4">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Mission Brief Generator</h1>
            <p class="text-gray-600 mt-2">Fill out the fields, save your progress, and download the final brief as a PDF.</p>
        </div>

        <!-- New Load Project Section -->
        <div class="bg-white rounded-xl shadow-lg p-4 mb-8 flex flex-wrap items-center gap-4">
            <label for="project-loader-dropdown" class="font-medium text-gray-700 whitespace-nowrap">Load Existing Project:</label>
            <select id="project-loader-dropdown" onchange="loadSelectedProject(this.value)" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                <option value="">-- Select a Project --</option>
            </select>
            <button type="button" onclick="document.getElementById('file-loader').click()" class="text-sm text-blue-600 hover:underline whitespace-nowrap">or Load from File...</button>
            <input type="file" id="file-loader" class="hidden" accept=".json" onchange="handleFileSelect(event)">
        </div>


        <!-- Main Form Container -->
        <div id="brief-form" class="bg-white rounded-xl shadow-lg p-6 sm:p-8">
            <header class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-2xl font-bold text-blue-700">Mission Brief</h2>
                <span class="text-sm font-medium text-gray-500">Version: <span id="version-display">1</span></span>
            </header>
            <input type="hidden" id="version-counter" value="1">

            <form id="mission-brief-form">
                <!-- Project Details Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div>
                        <label for="project-name" class="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                        <input type="text" id="project-name" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Enter project name...">
                    </div>
                    <div>
                        <label for="client-name" class="block text-sm font-medium text-gray-700 mb-1">Client</label>
                        <input type="text" id="client-name" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Enter client name...">
                    </div>
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" id="date" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Section Template -->
                <div class="space-y-8">
                    <!-- 1. Mission Objective -->
                    <section>
                        <h3 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">1. Mission Objective</h3>
                        <textarea id="mission-objective" rows="3" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="State the single, most important goal of this engagement..."></textarea>
                    </section>

                    <!-- 2. Background & Situation -->
                    <section>
                        <h3 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">2. Background & Situation</h3>
                        <textarea id="background" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Briefly describe the context, the core problem, or the opportunity..."></textarea>
                    </section>

                    <!-- 3. Key Deliverables -->
                    <section>
                        <div class="flex justify-between items-center mb-3 border-b pb-2">
                            <h3 class="text-xl font-semibold text-gray-800">3. Key Deliverables</h3>
                            <button type="button" onclick="addItem('deliverables-list')" class="no-export bg-blue-100 text-blue-700 text-sm font-medium px-3 py-1 rounded-md hover:bg-blue-200 transition-colors">Add Item</button>
                        </div>
                        <div id="deliverables-list" class="space-y-2">
                            <div class="flex items-center gap-2"><input type="text" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., Comprehensive market analysis report"><button type="button" onclick="this.parentElement.remove()" class="no-export remove-button bg-red-100 text-red-700 p-2 rounded-md hover:bg-red-200">X</button></div>
                        </div>
                    </section>

                    <!-- 4. Scope of Work -->
                    <section>
                        <h3 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">4. Scope of Work</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-medium text-gray-700 mb-2">In Scope</h4>
                                <textarea id="in-scope" rows="5" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Clearly define what activities and tasks are included..."></textarea>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-700 mb-2">Out of Scope</h4>
                                <textarea id="out-of-scope" rows="5" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Explicitly state what is not included..."></textarea>
                            </div>
                        </div>
                    </section>

                    <!-- 5. Team & Roles -->
                    <section>
                        <div class="flex justify-between items-center mb-3 border-b pb-2">
                            <h3 class="text-xl font-semibold text-gray-800">5. Team & Roles</h3>
                            <button type="button" onclick="addItem('team-list', true)" class="no-export bg-blue-100 text-blue-700 text-sm font-medium px-3 py-1 rounded-md hover:bg-blue-200 transition-colors">Add Role</button>
                        </div>
                        <div id="team-list" class="space-y-3">
                            <div class="flex items-center gap-2"><input type="text" class="w-1/3 p-2 border border-gray-300 rounded-md" placeholder="Role (e.g., Project Lead)"><input type="text" class="w-2/3 p-2 border border-gray-300 rounded-md" placeholder="Name"><button type="button" onclick="this.parentElement.remove()" class="no-export remove-button bg-red-100 text-red-700 p-2 rounded-md hover:bg-red-200">X</button></div>
                        </div>
                    </section>

                    <!-- 6. Project Resources & Data Management -->
                    <section>
                        <h3 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">6. Project Resources & Data Management</h3>
                        <label for="repo-link" class="block text-sm font-medium text-gray-700 mb-1">Central Repository Link</label>
                        <input type="url" id="repo-link" class="w-full p-2 border border-gray-300 rounded-md" placeholder="https://drive.google.com/...">
                        <p class="text-xs text-gray-500 mt-2">Data from the Ripple Group drive should be migrated to this central project folder upon kickoff.</p>
                    </section>
                    
                    <!-- 7. High-Level Timeline & Milestones -->
                    <section>
                        <div class="flex justify-between items-center mb-3 border-b pb-2">
                            <h3 class="text-xl font-semibold text-gray-800">7. High-Level Timeline & Milestones</h3>
                            <button type="button" onclick="addMilestone()" class="no-export bg-blue-100 text-blue-700 text-sm font-medium px-3 py-1 rounded-md hover:bg-blue-200 transition-colors">Add Milestone</button>
                        </div>
                        <div id="milestones-list" class="space-y-4">
                            <!-- Milestones will be dynamically added here -->
                        </div>
                    </section>

                    <!-- 8. Success Metrics -->
                    <section>
                        <div class="flex justify-between items-center mb-3 border-b pb-2">
                             <h3 class="text-xl font-semibold text-gray-800">8. Success Metrics</h3>
                             <button type="button" onclick="addItem('metrics-list')" class="no-export bg-blue-100 text-blue-700 text-sm font-medium px-3 py-1 rounded-md hover:bg-blue-200 transition-colors">Add Metric</button>
                        </div>
                        <div id="metrics-list" class="space-y-2">
                           <div class="flex items-center gap-2"><input type="text" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., 25% increase in qualified leads"><button type="button" onclick="this.parentElement.remove()" class="no-export remove-button bg-red-100 text-red-700 p-2 rounded-md hover:bg-red-200">X</button></div>
                        </div>
                    </section>
                </div>
            </form>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 flex flex-wrap justify-center gap-4">
            <button onclick="saveProgress()" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all shadow-md">
                Save Progress
            </button>
            <button onclick="downloadPDF()" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all shadow-md">
                Download as PDF
            </button>
        </div>
    </div>

    <script>
        const PROJECT_DB_PREFIX = 'mission-brief-';

        // --- Dynamic Item Functions ---
        function addItem(listId, isTeamRole = false) {
            const list = document.getElementById(listId);
            if (!list) return;

            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex items-center gap-2';
            
            if (isTeamRole) {
                itemDiv.innerHTML = `<input type="text" class="w-1/3 p-2 border border-gray-300 rounded-md" placeholder="Role"><input type="text" class="w-2/3 p-2 border border-gray-300 rounded-md" placeholder="Name"><button type="button" onclick="this.parentElement.remove()" class="no-export remove-button bg-red-100 text-red-700 p-2 rounded-md hover:bg-red-200">X</button>`;
            } else {
                itemDiv.innerHTML = `<input type="text" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter another item..."><button type="button" onclick="this.parentElement.remove()" class="no-export remove-button bg-red-100 text-red-700 p-2 rounded-md hover:bg-red-200">X</button>`;
            }
            list.appendChild(itemDiv);
        }

        function addMilestone(name = '', startDate = '', endDate = '') {
            const list = document.getElementById('milestones-list');
            if (!list) return;

            const itemDiv = document.createElement('div');
            itemDiv.className = 'milestone-item grid grid-cols-1 sm:grid-cols-12 gap-2 items-center';
            itemDiv.innerHTML = `
                <input type="text" class="sm:col-span-6 w-full p-2 border border-gray-300 rounded-md" placeholder="Milestone Name" value="${name}">
                <input type="date" class="sm:col-span-2 w-full p-2 border border-gray-300 rounded-md" title="Start Date" value="${startDate}">
                <input type="date" class="sm:col-span-2 w-full p-2 border border-gray-300 rounded-md" title="End Date" value="${endDate}">
                <div class="sm:col-span-2 flex justify-end">
                     <button type="button" onclick="this.closest('.milestone-item').remove()" class="no-export remove-button bg-red-100 text-red-700 p-2 rounded-md hover:bg-red-200 w-full sm:w-auto">X</button>
                </div>
            `;
            list.appendChild(itemDiv);
        }

        // --- Save/Load Progress Functions ---
        function getFormData() {
            const version = parseInt(document.getElementById('version-counter').value);
            const data = {
                version: version,
                projectName: document.getElementById('project-name').value.trim(),
                clientName: document.getElementById('client-name').value,
                date: document.getElementById('date').value,
                missionObjective: document.getElementById('mission-objective').value,
                background: document.getElementById('background').value,
                inScope: document.getElementById('in-scope').value,
                outOfScope: document.getElementById('out-of-scope').value,
                repoLink: document.getElementById('repo-link').value,
                deliverables: [], team: [], milestones: [], metrics: []
            };
            document.querySelectorAll('#deliverables-list input[type="text"]').forEach(input => data.deliverables.push(input.value));
            document.querySelectorAll('#metrics-list input[type="text"]').forEach(input => data.metrics.push(input.value));
            document.querySelectorAll('#team-list .flex').forEach(item => {
                const inputs = item.querySelectorAll('input');
                data.team.push({ role: inputs[0].value, name: inputs[1].value });
            });
            document.querySelectorAll('#milestones-list .milestone-item').forEach(item => {
                const inputs = item.querySelectorAll('input');
                data.milestones.push({ name: inputs[0].value, start: inputs[1].value, end: inputs[2].value });
            });
            return data;
        }

        function saveProgress() {
            const versionCounter = document.getElementById('version-counter');
            versionCounter.value = parseInt(versionCounter.value) + 1;
            
            const data = getFormData();

            if (!data.projectName) {
                alert('Please enter a Project Name before saving.');
                return;
            }

            // Save to Local Storage
            localStorage.setItem(PROJECT_DB_PREFIX + data.projectName, JSON.stringify(data));
            populateProjectDropdown(); // Refresh dropdown
            
            // Download JSON backup
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${data.projectName} - Mission Brief Data - v${data.version}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`Project "${data.projectName}" (v${data.version}) saved successfully!`);
        }

        function handleFileSelect(event) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    populateForm(data);
                    // Also save this manually loaded project to local storage
                    if (data.projectName) {
                        localStorage.setItem(PROJECT_DB_PREFIX + data.projectName, JSON.stringify(data));
                        populateProjectDropdown();
                    }
                } catch (error) {
                    alert('Error: Could not parse the file. Please make sure it is a valid mission brief JSON file.');
                }
            };
            reader.readAsText(event.target.files[0]);
            event.target.value = ''; // Reset file input
        }

        function populateForm(data) {
            const loadedVersion = data.version || 1;
            document.getElementById('version-counter').value = loadedVersion;
            document.getElementById('version-display').textContent = loadedVersion;

            document.getElementById('project-name').value = data.projectName || '';
            document.getElementById('client-name').value = data.clientName || '';
            document.getElementById('date').value = data.date || '';
            document.getElementById('mission-objective').value = data.missionObjective || '';
            document.getElementById('background').value = data.background || '';
            document.getElementById('in-scope').value = data.inScope || '';
            document.getElementById('out-of-scope').value = data.outOfScope || '';
            document.getElementById('repo-link').value = data.repoLink || '';

            const clearAndFill = (listId, items, creatorFn) => {
                const list = document.getElementById(listId);
                list.innerHTML = ''; // Clear existing items
                if (items) items.forEach(item => creatorFn(item));
            };

            clearAndFill('deliverables-list', data.deliverables, (item) => {
                const list = document.getElementById('deliverables-list');
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center gap-2';
                itemDiv.innerHTML = `<input type="text" class="w-full p-2 border border-gray-300 rounded-md" value="${item}"><button type="button" onclick="this.parentElement.remove()" class="no-export remove-button bg-red-100 text-red-700 p-2 rounded-md hover:bg-red-200">X</button>`;
                list.appendChild(itemDiv);
            });
            
            clearAndFill('metrics-list', data.metrics, (item) => {
                 const list = document.getElementById('metrics-list');
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center gap-2';
                itemDiv.innerHTML = `<input type="text" class="w-full p-2 border border-gray-300 rounded-md" value="${item}"><button type="button" onclick="this.parentElement.remove()" class="no-export remove-button bg-red-100 text-red-700 p-2 rounded-md hover:bg-red-200">X</button>`;
                list.appendChild(itemDiv);
            });

            clearAndFill('team-list', data.team, (item) => {
                const list = document.getElementById('team-list');
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center gap-2';
                itemDiv.innerHTML = `<input type="text" class="w-1/3 p-2 border border-gray-300 rounded-md" value="${item.role}"><input type="text" class="w-2/3 p-2 border border-gray-300 rounded-md" value="${item.name}"><button type="button" onclick="this.parentElement.remove()" class="no-export remove-button bg-red-100 text-red-700 p-2 rounded-md hover:bg-red-200">X</button>`;
                list.appendChild(itemDiv);
            });

            clearAndFill('milestones-list', data.milestones, (item) => addMilestone(item.name, item.start, item.end));
        }

        // --- New Dropdown Functions ---
        function populateProjectDropdown() {
            const dropdown = document.getElementById('project-loader-dropdown');
            const projects = Object.keys(localStorage)
                .filter(key => key.startsWith(PROJECT_DB_PREFIX))
                .map(key => key.substring(PROJECT_DB_PREFIX.length));

            const selectedValue = dropdown.value;
            
            dropdown.innerHTML = '<option value="">-- Select a Project --</option>';

            if (projects.length > 0) {
                projects.sort().forEach(projectName => {
                    const option = document.createElement('option');
                    option.value = projectName;
                    option.textContent = projectName;
                    dropdown.appendChild(option);
                });
            }
            dropdown.value = selectedValue;
        }

        function loadSelectedProject(projectName) {
            if (!projectName) return;
            const data = JSON.parse(localStorage.getItem(PROJECT_DB_PREFIX + projectName));
            populateForm(data);
        }

        // --- PDF Download Function ---
        function downloadPDF() {
            const element = document.getElementById('brief-form');
            const projectName = document.getElementById('project-name').value || 'Untitled Project';
            const currentVersion = document.getElementById('version-counter').value;
            const filename = `${projectName.trim()} - Mission Brief - v${currentVersion}.pdf`;

            const buttonsToHide = document.querySelectorAll('.no-export');
            buttonsToHide.forEach(btn => btn.style.display = 'none');

            const opt = {
              margin:       0.5,
              filename:     filename,
              image:        { type: 'jpeg', quality: 0.98 },
              html2canvas:  { scale: 2, useCORS: true },
              jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().from(element).set(opt).save().then(() => {
                buttonsToHide.forEach(btn => btn.style.display = '');
            });
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            addMilestone('Phase 1: Discovery & Analysis');
            addMilestone('Phase 2: Strategy & Development');
            addMilestone('Phase 3: Implementation & Testing');
            populateProjectDropdown();
        });
    </script>

</body>
</html>

